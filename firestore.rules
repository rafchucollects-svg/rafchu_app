rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // User profiles - readable by all (for shared links and marketplace)
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && (
        request.auth.uid == userId ||
        request.auth.token.email == 'rafchucollects@gmail.com'
      );
    }

    // Vendor inventory collections owned by each authenticated user.
    match /collections/{userId} {
      // Allow vendors to make inventory public for marketplace
      allow read: if resource.data.shareEnabled == true ||
        request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Collector collections owned by each authenticated user.
    match /collector_collections/{userId} {
      allow read: if resource.data.shareEnabled == true ||
        (request.auth != null && request.auth.uid == userId);
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Collector wishlists owned by each authenticated user.
    match /collector_wishlists/{userId} {
      // Wishlists are readable by authenticated users (for insights)
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Conversations between users
    match /conversations/{conversationId} {
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.participants ||
        !exists(/databases/$(database)/documents/conversations/$(conversationId))
      );
      allow write: if request.auth != null && (
        request.auth.uid in resource.data.participants ||
        request.auth.uid in request.resource.data.participants
      );
      allow create: if request.auth != null &&
        request.auth.uid in request.resource.data.participants;
    }

    // Messages within conversations - only participants can read/write
    match /conversations/{conversationId}/messages/{messageId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
    }

    // Transactions - both buyer and seller can read/write their transactions
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null;
    }

    // Ratings - readable by anyone (for displaying on profiles), writable once by transaction participants
    match /ratings/{ratingId} {
      allow read: if true; // Public read for vendor ratings display
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.fromUserId;
    }

    // Vendor Transactions - for logging sales in My Inventory
    match /vendor_transactions/{transactionId} {
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }

    // Transaction Log - subcollection for vendor transaction history
    match /transactions/{userId}/entries/{entryId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Inventory Snapshots - subcollection for vendor inventory snapshots
    match /inventory_snapshots/{userId}/snapshots/{snapshotId} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Vendor Access Requests - users can create and read their own, admins can read/update all
    match /vendorAccessRequests/{requestId} {
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        request.auth.token.email == 'rafchucollects@gmail.com'
      );
      allow update: if request.auth != null && 
        request.auth.token.email == 'rafchucollects@gmail.com';
      allow list: if request.auth != null && 
        request.auth.token.email == 'rafchucollects@gmail.com';
    }

    // Feedback submissions - users can create, admins can read/update all
    match /feedback/{feedbackId} {
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        request.auth.token.email == 'rafchucollects@gmail.com'
      );
      allow update: if request.auth != null && 
        request.auth.token.email == 'rafchucollects@gmail.com';
      allow list: if request.auth != null && 
        request.auth.token.email == 'rafchucollects@gmail.com';
    }

    // Community Image Submissions - users can create, admins can read/update all
    match /communityImageSubmissions/{submissionId} {
      // Any authenticated user can submit
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.submittedBy;
      
      // Users can read their own submissions, admins can read all
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.submittedBy ||
        request.auth.token.email == 'rafchucollects@gmail.com'
      );
      
      // Only admins can update/delete (for approval/rejection)
      allow update, delete: if request.auth != null && 
        request.auth.token.email == 'rafchucollects@gmail.com';
      
      // Admins can list all submissions
      allow list: if request.auth != null && 
        request.auth.token.email == 'rafchucollects@gmail.com';
    }

    // Approved Community Images - public read, admin write
    match /approvedCommunityImages/{cardId} {
      // Anyone can read approved images metadata
      allow read: if true;
      
      // Only admins can write/update/delete
      allow write, delete: if request.auth != null && 
        request.auth.token.email == 'rafchucollects@gmail.com';
    }

    // Community Images - For approved images used in card database
    match /community_images/{imageId} {
      // Public read for approved images
      allow read: if true;
      
      // Only admins and Cloud Functions can write
      allow write: if request.auth != null && 
        request.auth.token.email == 'rafchucollects@gmail.com';
    }

    // Card Database Cache - Public read, Cloud Functions write
    match /card_database/{cardKey} {
      // Public read for all authenticated users (for instant search)
      allow read: if request.auth != null;
      
      // No direct writes from clients - only Cloud Functions can update
      // (Cloud Functions bypass security rules by default when using Admin SDK)
      allow write: if false;
    }

    // Update Logs - Cloud Functions only
    match /update_logs/{logId} {
      // Admins can read logs for monitoring
      allow read: if request.auth != null && 
        request.auth.token.email == 'rafchucollects@gmail.com';
      
      // No direct writes from clients - only Cloud Functions can write
      allow write: if false;
    }

    // Default deny for all other documents unless explicitly allowed above.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
