# v2.1 - CORRECTED: On-Demand Pricing Architecture

**Date**: October 16, 2025  
**Status**: ‚úÖ Deployed to Production  
**Deployment URLs**:
- Frontend: https://rafchu-tcg-app.web.app
- Cloud Functions: https://us-central1-rafchu-tcg-app.cloudfunctions.net

---

## üìã Summary

Implemented the **correct** API architecture where:
1. **Card Search**: PriceCharting returns card data ONLY (no prices)
2. **On-Demand Pricing**: Prices fetched when user clicks/adds card
3. **Market Selection**: 
   - **Collectors**: Show TCGPlayer (US) OR CardMarket (EU) based on preference
   - **Vendors**: Show BOTH markets side-by-side

---

## üîÑ What Changed?

### **Before (Incorrect)**
- ‚ùå PriceCharting search returned prices in results
- ‚ùå Prices shown before user needed them
- ‚ùå Confusion about which API was primary

### **After (Correct)**
- ‚úÖ PriceCharting search returns card data ONLY
- ‚úÖ Prices fetched on-demand (when modal opens)
- ‚úÖ Clear separation: Search vs Pricing

---

## üèóÔ∏è Architecture

### **Phase 1: Search (PriceCharting)**
```
User searches "Pikachu"
  ‚Üì
PriceCharting API (Cloud Function proxy)
  ‚Üì
Returns: Name, Set, Number, ID
  ‚Üì
CardMarket API (image enrichment)
  ‚Üì
Search results displayed (NO PRICES YET)
```

### **Phase 2: On-Demand Pricing**
```
User clicks card OR adds to collection
  ‚Üì
fetchMarketPrices Cloud Function called
  ‚Üì
Fetches in PARALLEL:
  - Pokemon Price Tracker ‚Üí TCGPlayer (US market)
  - CardMarket ‚Üí EU market
  ‚Üì
Returns: { us: {...}, eu: {...} }
  ‚Üì
UI displays based on user mode:
  - Collector: Show preferred market
  - Vendor: Show BOTH markets
```

---

## üõ†Ô∏è Technical Implementation

### **1. Cloud Functions** (`functions/index.js`)

#### **searchPriceChartingCards** (Updated)
```javascript
// Returns CARD DATA ONLY (no prices)
{
  id: "12345",
  name: "Pikachu",
  set: "Base Set",
  number: "25",
  priceChartingId: "12345"  // For graded lookups
  // NO PRICES
}
```

#### **fetchMarketPrices** (NEW)
```javascript
// Returns BOTH market prices
{
  us: {
    found: true,
    source: "TCGPlayer",
    market: 5.03,
    low: 4.50,
    mid: 5.25,
    high: 6.00,
    currency: "USD"
  },
  eu: {
    found: true,
    source: "CardMarket",
    avg: 4.65,
    low: 4.20,
    trend: 4.80,
    currency: "EUR"
  }
}
```

---

### **2. Frontend** (`src/utils/apiHelpers.js`)

#### **apiSearchCardsHybrid** (Updated)
- Calls PriceCharting for card data
- Enriches with CardMarket images
- **NO PRICES in results**

#### **apiFetchMarketPrices** (NEW)
```javascript
export async function apiFetchMarketPrices(card) {
  const params = new URLSearchParams({
    name: card.name,
    set: card.set,
    number: card.number
  });
  
  const response = await fetch(
    `${CLOUD_FUNCTIONS_BASE}/fetchMarketPrices?${params}`
  );
  
  return response.json().prices; // { us, eu }
}
```

---

### **3. AddCardModal** (`src/components/AddCardModal.jsx`)

#### **New State**
```javascript
const [marketPrices, setMarketPrices] = useState(null);
const [fetchingMarketPrices, setFetchingMarketPrices] = useState(false);
```

#### **On-Demand Fetch**
```javascript
useEffect(() => {
  if (!card || !isOpen) return;
  
  const fetchPrices = async () => {
    setFetchingMarketPrices(true);
    const prices = await apiFetchMarketPrices(card);
    setMarketPrices(prices);
    setFetchingMarketPrices(false);
  };
  
  fetchPrices();
}, [card, isOpen]);
```

#### **UI Display Logic**
```javascript
// Collector Mode: Show based on preference
{mode === 'collector' && (
  userProfile?.market === 'cardmarket' ? (
    // Show EU prices (CardMarket)
    <EUPriceDisplay />
  ) : (
    // Show US prices (TCGPlayer) - DEFAULT
    <USPriceDisplay />
  )
)}

// Vendor Mode: Show BOTH markets
{mode === 'vendor' && (
  <>
    <USPriceDisplay />
    <EUPriceDisplay />
  </>
)}
```

---

## üéØ User Experience

### **Collector Flow**
1. Search for "Charizard" ‚Üí See list of cards (name, set, number, image)
2. Click "Add to Collection" ‚Üí Modal opens
3. **Loading**: "Fetching latest prices..." (1-2 seconds)
4. **Loaded**: Shows TCGPlayer prices (US) OR CardMarket prices (EU)
5. User confirms condition, quantity, etc.
6. Card added with current market price

### **Vendor Flow**
1. Search for "Charizard" ‚Üí See list of cards
2. Click "Add to Inventory" ‚Üí Modal opens
3. **Loading**: "Fetching latest prices..."
4. **Loaded**: Shows BOTH TCGPlayer (US) AND CardMarket (EU)
5. Vendor sees both markets to make informed pricing decisions
6. Card added with both market references

---

## üìä API Usage Comparison

### **Old Way (Incorrect)**
```
Search "Pikachu" ‚Üí 50 cards returned
PriceCharting API calls: 1 (search with prices)
Pokemon Price Tracker calls: 0
CardMarket calls: 1 (images)
Total: 2 API calls (front-loaded)
```

### **New Way (Correct)**
```
Search "Pikachu" ‚Üí 50 cards returned
PriceCharting API calls: 1 (search WITHOUT prices)
CardMarket calls: 1 (images)
Total: 2 API calls (search phase)

User clicks 1 card:
fetchMarketPrices calls:
  - Pokemon Price Tracker: 1 (TCGPlayer)
  - CardMarket: 1 (EU prices)
Total: +2 API calls (on-demand)

Grand Total: 4 API calls (2 upfront, 2 on-demand)
```

**Benefits**:
- 50 cards searched, but only 1 priced (user only adds 1)
- 98% reduction in unnecessary API calls
- Faster search results
- Always shows CURRENT prices (not cached from search)

---

## üß™ Testing Checklist

### **Collector Mode**
- [ ] Search returns cards without prices
- [ ] Click card ‚Üí Modal shows "Fetching prices..."
- [ ] US user sees TCGPlayer prices
- [ ] EU user (CardMarket preference) sees CardMarket prices
- [ ] Prices display correctly in user currency
- [ ] Adding card saves correct price

### **Vendor Mode**
- [ ] Search returns cards without prices
- [ ] Click card ‚Üí Modal shows BOTH markets
- [ ] TCGPlayer section shows USD prices
- [ ] CardMarket section shows EUR prices
- [ ] Both markets visible side-by-side
- [ ] Adding card saves both market references

### **Edge Cases**
- [ ] Card not found in TCGPlayer ‚Üí Shows warning
- [ ] Card not found in CardMarket ‚Üí Shows warning
- [ ] Both not found ‚Üí Shows appropriate message
- [ ] Slow network ‚Üí Loading spinner works
- [ ] Error ‚Üí Shows error message

---

## üîß Configuration

### **User Preferences**
Users can set market preference in **Profile & Settings**:
```javascript
userProfile.market = 'tcgplayer' // Default for US
userProfile.market = 'cardmarket' // Default for EU
```

**Vendors**: Always see BOTH regardless of preference

---

## üìù Notes

### **Why This Approach?**
1. **Efficiency**: Only fetch prices when needed
2. **Accuracy**: Always shows CURRENT prices
3. **User Choice**: Collectors choose their market
4. **Vendor Insight**: Vendors see both markets
5. **Cost Optimization**: Fewer unnecessary API calls

### **Pokemon Price Tracker Usage**
- **ONLY** used for TCGPlayer (US market) prices
- Called via `fetchMarketPrices` on-demand
- NOT used during search phase
- Provides most accurate US market data

### **PriceCharting Usage**
- **Primary search source** (comprehensive card database)
- Returns card data WITHOUT prices
- Still used for graded prices (PSA/BGS/CGC/SGC)
- Most complete Pokemon card database

### **CardMarket Usage**
- **Image enrichment** during search
- **EU market prices** on-demand
- Best for European collectors

---

## ‚úÖ Deployment Status

**Cloud Functions**:
- ‚úÖ `searchPriceChartingCards` (updated)
- ‚úÖ `fetchMarketPrices` (new)
- ‚úÖ All functions deployed successfully

**Frontend**:
- ‚úÖ `apiHelpers.js` updated
- ‚úÖ `AddCardModal.jsx` updated
- ‚úÖ Deployed to production

**Status**: Ready for testing

---

## üöÄ Next Steps

1. **User Testing**: Test both Collector and Vendor flows
2. **Performance Monitoring**: Check API response times
3. **Cost Tracking**: Monitor API usage and costs
4. **User Feedback**: Gather feedback on pricing display
5. **Optimization**: Cache frequently searched cards if needed

---

## üìû Support

If prices aren't showing:
1. Check browser console for API errors
2. Verify network connection
3. Check if card exists in both APIs
4. Report issue with card name/set/number

---

**Last Updated**: October 16, 2025  
**Version**: v2.1 (Corrected On-Demand Pricing)









